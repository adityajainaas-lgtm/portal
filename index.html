<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meesho — Advanced Profit Platform</title>

  <!-- Tailwind CDN (fast dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: linear-gradient(180deg,#041023,#071427); color: #e6eef6; min-height:100vh; }
    .glass { background: rgba(6,10,18,0.6); backdrop-filter: blur(6px); }
    .muted { color: #9aa6b2; }
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
  </style>
</head>
<body class="p-4 antialiased">

  <div class="max-w-4xl mx-auto">

    <!-- Header -->
    <header class="flex items-start justify-between mb-4">
      <div>
        <h1 class="text-2xl font-semibold">Meesho · Local — Profit Platform</h1>
        <p class="muted text-sm mt-1">Add Meesho order → enter local price → platform saves both and shows deep reports.</p>
      </div>
      <div class="text-right">
        <div id="userEmail" class="muted text-sm">Not signed in</div>
        <div id="authActions" class="mt-2">
          <button id="btnLogout" class="hidden px-3 py-1 rounded bg-red-600 text-white text-sm">Logout</button>
        </div>
      </div>
    </header>

    <!-- LOGIN card -->
    <section id="loginCard" class="glass p-4 rounded-lg shadow-lg max-w-md mx-auto">
      <h2 class="text-lg font-medium mb-2">Sign in (Email)</h2>
      <div class="muted text-sm mb-4">Only authorized account allowed.</div>
      <div class="space-y-2">
        <input id="emailInput" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" placeholder="Email" value="avinavrashujain@gmail.com"/>
        <input id="passwordInput" type="password" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" placeholder="Password" value="123456"/>
        <div class="flex gap-2">
          <button id="btnLogin" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-black font-semibold py-2 rounded">Login</button>
          <button id="btnPreview" class="flex-1 bg-slate-700 hover:bg-slate-600 text-sm py-2 rounded">Preview (dev)</button>
        </div>
      </div>
    </section>

    <!-- MAIN APP -->
    <main id="app" class="hidden mt-6 grid gap-4 lg:grid-cols-2">

      <!-- Left column: Order form + recent -->
      <div class="space-y-4">
        <!-- Add order -->
        <div class="glass p-4 rounded-lg shadow-lg">
          <h3 class="text-lg font-medium mb-2">Add Meesho Order</h3>

          <form id="meeshoForm" class="space-y-3">
            <div>
              <label class="text-sm muted">Product</label>
              <input id="productInput" list="productList" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" placeholder="Type or choose product" required />
              <datalist id="productList"></datalist>
            </div>

            <div class="flex gap-2">
              <div class="flex-1">
                <label class="text-sm muted">Quantity</label>
                <input id="qtyInput" type="number" min="1" value="1" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" required />
              </div>
              <div class="w-32">
                <label class="text-sm muted">Platform</label>
                <select id="platformInput" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" required>
                  <option value="meesho">Meesho</option>
                </select>
              </div>
            </div>

            <div>
              <label class="text-sm muted">Meesho Total Amount (₹)</label>
              <input id="meeshoTotal" type="number" step="0.01" min="0" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" placeholder="e.g. 840" required />
            </div>

            <div class="flex items-center justify-between">
              <div class="muted text-sm">Meesho per-unit: <span id="meeshoPer">₹0.00</span></div>
              <div class="flex gap-2">
                <button id="btnAddMeesho" type="button" class="bg-emerald-500 hover:bg-emerald-600 text-black font-semibold px-4 py-2 rounded">Next: Local price</button>
                <button id="btnClearForm" type="button" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded">Clear</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Recent orders list -->
        <div class="glass p-4 rounded-lg shadow-lg overflow-auto" style="max-height:420px">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-medium">Recent Orders</h4>
            <div class="text-sm muted">
              <button id="btnRefresh" class="px-2 py-1 rounded bg-slate-700">Refresh</button>
            </div>
          </div>
          <div id="recentList" class="space-y-2 text-sm"></div>
        </div>
      </div>

      <!-- Right column: Dashboard, filters, products -->
      <aside class="space-y-4">
        <!-- Summary -->
        <div class="glass p-4 rounded-lg shadow-lg">
          <h3 class="text-lg font-medium mb-2">Summary</h3>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 bg-slate-900 rounded">
              <div class="muted text-sm">Total Orders</div>
              <div id="totalOrders" class="text-xl font-semibold">0</div>
            </div>
            <div class="p-3 bg-slate-900 rounded">
              <div class="muted text-sm">Total Items Sold</div>
              <div id="totalItems" class="text-xl font-semibold">0</div>
            </div>
            <div class="p-3 bg-slate-900 rounded">
              <div class="muted text-sm">Meesho Revenue</div>
              <div id="meeshoRev" class="text-xl font-semibold">₹0.00</div>
            </div>
            <div class="p-3 bg-slate-900 rounded">
              <div class="muted text-sm">Local Revenue</div>
              <div id="localRev" class="text-xl font-semibold">₹0.00</div>
            </div>
            <div class="p-3 bg-slate-900 rounded col-span-2">
              <div class="muted text-sm">Total Profit (Meesho - Local)</div>
              <div id="totalProfit" class="text-xl font-semibold">₹0.00</div>
            </div>
          </div>
        </div>

        <!-- Filters + charts -->
        <div class="glass p-4 rounded-lg shadow-lg">
          <h3 class="text-lg font-medium mb-2">Reports & Filters</h3>
          <div class="space-y-2">
            <div class="flex gap-2">
              <input id="fromDate" type="date" class="flex-1 p-2 rounded bg-transparent border border-slate-700 text-white" />
              <input id="toDate" type="date" class="flex-1 p-2 rounded bg-transparent border border-slate-700 text-white" />
            </div>

            <select id="reportProduct" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white">
              <option value="">-- All products --</option>
            </select>

            <select id="reportPlatform" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white">
              <option value="">-- All platforms --</option>
              <option value="meesho">Meesho</option>
              <option value="local">Local</option>
            </select>

            <div class="flex gap-2">
              <button id="btnApplyFilter" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-black py-2 rounded">Apply</button>
              <button id="btnResetFilter" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded">Reset</button>
            </div>

            <div class="mt-3">
              <canvas id="revenueChart" height="120"></canvas>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="btnExport" class="flex-1 bg-indigo-600 hover:bg-indigo-700 py-2 rounded">Export CSV</button>
            </div>
          </div>
        </div>

        <!-- Products compact list -->
        <div class="glass p-4 rounded-lg shadow-lg overflow-auto" style="max-height:300px">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-medium">Products</h4>
            <div class="muted text-sm">Tap to view history</div>
          </div>
          <div id="productsContainer" class="space-y-2 text-sm"></div>
        </div>
      </aside>

    </main>

    <!-- Footer -->
    <footer class="text-center muted mt-6 text-sm">
      Secure your Firebase rules before sharing. Enable Email/Password auth in Firebase console and create the user if needed.
    </footer>
  </div>

  <!-- Local modal for asking Local price -->
  <div id="localModal" class="hidden">
    <div class="modal-backdrop">
      <div class="bg-slate-900 p-4 rounded-lg w-full max-w-sm">
        <h4 class="text-lg font-medium mb-2">Local sale price</h4>
        <div class="muted text-sm mb-3" id="modalProductInfo"></div>
        <label class="text-sm muted">Local total amount (₹)</label>
        <input id="localTotalInput" type="number" step="0.01" min="0" class="w-full p-2 rounded bg-transparent border border-slate-700 text-white" placeholder="e.g. 750" />
        <div class="flex gap-2 mt-3">
          <button id="modalSave" class="flex-1 bg-emerald-500 py-2 rounded text-black font-semibold">Save both</button>
          <button id="modalCancel" class="flex-1 bg-slate-700 py-2 rounded">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase & App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBsMQUXlXv5qQRWGa4ImL48WieON8nsEBA",
      authDomain: "portal-85f3d.firebaseapp.com",
      databaseURL: "https://portal-85f3d-default-rtdb.firebaseio.com/",
      projectId: "portal-85f3d",
      storageBucket: "portal-85f3d.firebasestorage.app",
      messagingSenderId: "758294315137",
      appId: "1:758294315137:web:7d0ccb6a7193eea9228d80",
      measurementId: "G-YNSJVMPWWP"
    };

    const ALLOWED_EMAIL = 'avinavrashujain@gmail.com';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---------- DOM ----------
    const loginCard = document.getElementById('loginCard');
    const appEl = document.getElementById('app');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const userEmail = document.getElementById('userEmail');
    const btnPreview = document.getElementById('btnPreview');

    const productInput = document.getElementById('productInput');
    const productList = document.getElementById('productList');
    const qtyInput = document.getElementById('qtyInput');
    const platformInput = document.getElementById('platformInput');
    const meeshoTotal = document.getElementById('meeshoTotal');
    const meeshoPer = document.getElementById('meeshoPer');
    const btnAddMeesho = document.getElementById('btnAddMeesho');
    const btnClearForm = document.getElementById('btnClearForm');
    const recentList = document.getElementById('recentList');
    const btnRefresh = document.getElementById('btnRefresh');

    const totalOrdersEl = document.getElementById('totalOrders');
    const totalItemsEl = document.getElementById('totalItems');
    const meeshoRevEl = document.getElementById('meeshoRev');
    const localRevEl = document.getElementById('localRev');
    const totalProfitEl = document.getElementById('totalProfit');

    const reportProduct = document.getElementById('reportProduct');
    const reportPlatform = document.getElementById('reportPlatform');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const btnApplyFilter = document.getElementById('btnApplyFilter');
    const btnResetFilter = document.getElementById('btnResetFilter');
    const btnExport = document.getElementById('btnExport');

    const productsContainer = document.getElementById('productsContainer');

    const modalRoot = document.getElementById('localModal');
    const modalProductInfo = document.getElementById('modalProductInfo');
    const localTotalInput = document.getElementById('localTotalInput');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');

    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    let revenueChart = null;

    // caches
    let productsCache = {}; // slug -> product object
    let ordersCache = {};   // orderId -> order object

    // in-progress staged meesho order (waiting for local input)
    let stagedMeesho = null;

    // ---------- helpers ----------
    const slugify = s => String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
    const fmt = x => '₹' + (Number(x)||0).toFixed(2);
    const now = () => Date.now();

    // ---------- auth ----------
    btnLogin.addEventListener('click', async ()=>{
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if(!email || !password){ alert('enter email + password'); return; }
      try{
        // try sign in
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){
        // if user not found and email matches allowed, create for convenience
        if(err.code === 'auth/user-not-found' && email === ALLOWED_EMAIL){
          try{
            await createUserWithEmailAndPassword(auth, email, password);
            await signInWithEmailAndPassword(auth, email, password);
          } catch(e){ alert('Failed to create user: ' + e.message); return; }
        } else {
          alert('Login failed: ' + (err.message || err.code));
        }
      }
    });

    btnLogout.addEventListener('click', async ()=> {
      await signOut(auth);
    });

    // preview (dev) to view UI without auth - remove in production
    btnPreview.addEventListener('click', ()=> {
      loginCard.classList.add('hidden');
      appEl.classList.remove('hidden');
      userEmail.textContent = 'Preview';
      btnLogout.classList.remove('hidden');
      attachRealtime();
    });

    onAuthStateChanged(auth, user=>{
      if(user && user.email === ALLOWED_EMAIL){
        loginCard.classList.add('hidden');
        appEl.classList.remove('hidden');
        userEmail.textContent = user.email;
        btnLogout.classList.remove('hidden');
        attachRealtime();
      } else {
        loginCard.classList.remove('hidden');
        appEl.classList.add('hidden');
        userEmail.textContent = 'Not signed in';
        btnLogout.classList.add('hidden');
      }
    });

    // ---------- realtime listeners ----------
    function attachRealtime(){
      // products
      onValue(ref(db, 'products'), snap=>{
        productsCache = snap.val() || {};
        renderProductDatalist();
        renderProductsPanel();
        populateProductFilter();
        computeSummary();
      });
      // orders
      onValue(ref(db, 'orders'), snap=>{
        ordersCache = snap.val() || {};
        renderRecentOrders();
        computeSummary();
        updateRevenueChart();
      });
    }

    // ---------- UI rendering ----------
    function renderProductDatalist(){
      productList.innerHTML = '';
      Object.values(productsCache).forEach(p=>{
        const o = document.createElement('option'); o.value = p.name || p.slug; productList.appendChild(o);
      });
    }

    function renderProductsPanel(){
      productsContainer.innerHTML = '';
      const rows = Object.entries(productsCache).sort((a,b)=>{
        const aa = a[1], bb = b[1];
        const sa = (aa.meesho?.totalQuantity||0) + (aa.local?.totalQuantity||0);
        const sb = (bb.meesho?.totalQuantity||0) + (bb.local?.totalQuantity||0);
        return sb - sa;
      });
      rows.forEach(([slug,p])=>{
        const el = document.createElement('div'); el.className='p-3 bg-slate-900 rounded';
        el.innerHTML = `<div class="flex justify-between"><div><strong>${p.name||slug}</strong><div class="muted text-xs">${slug}</div></div><div class="text-right"><div class="muted text-xs">Sold</div><div class="font-semibold">${(p.meesho?.totalQuantity||0)+(p.local?.totalQuantity||0)}</div></div></div>
          <div class="mt-2 text-xs muted">Meesho: ${(p.meesho?.totalQuantity||0)} @ ${fmt(p.meesho?.avgUnitPrice||0)} (${fmt(p.meesho?.totalRevenue||0)})</div>
          <div class="text-xs muted">Local: ${(p.local?.totalQuantity||0)} @ ${fmt(p.local?.avgUnitPrice||0)} (${fmt(p.local?.totalRevenue||0)})</div>
          <div class="mt-2"><button data-slug="${slug}" class="viewHistory px-2 py-1 text-xs rounded bg-slate-700">History</button></div>`;
        productsContainer.appendChild(el);
      });
      document.querySelectorAll('.viewHistory').forEach(b=>{
        b.addEventListener('click', ()=> showProductHistory(b.dataset.slug));
      });
    }

    function renderRecentOrders(){
      recentList.innerHTML = '';
      const arr = Object.entries(ordersCache || {}).map(([id,o])=>({id,...o})).sort((a,b)=> b.timestamp - a.timestamp);
      arr.slice(0,100).forEach(o=>{
        const div = document.createElement('div'); div.className='p-2 bg-slate-900 rounded flex justify-between';
        div.innerHTML = `<div><div class="text-sm"><strong>${o.productName}</strong> <span class="muted text-xs">(${o.productSlug})</span></div><div class="muted text-xs">${o.quantity} × ${fmt(o.meeshoUnit)} (Meesho) | ${fmt(o.localUnit)} (Local)</div></div>
          <div class="text-right"><div class="font-semibold">${fmt(o.meeshoTotal)}</div><div class="muted text-xs">${new Date(o.timestamp).toLocaleString()}</div></div>`;
        recentList.appendChild(div);
      });
    }

    // ---------- form interactions ----------
    qtyInput.addEventListener('input', updateMeeshoPer);
    meeshoTotal.addEventListener('input', updateMeeshoPer);
    function updateMeeshoPer(){
      const q = Number(qtyInput.value) || 0;
      const t = Number(meeshoTotal.value) || 0;
      const per = q>0 ? (t/q) : 0;
      meeshoPer.textContent = fmt(per.toFixed(2));
    }

    btnClearForm.addEventListener('click', ()=>{
      productInput.value=''; qtyInput.value=1; platformInput.value='meesho'; meeshoTotal.value=''; updateMeeshoPer();
    });

    // On clicking "Next: Local price" show modal to ask local total for same qty
    btnAddMeesho.addEventListener('click', ()=>{
      const name = (productInput.value||'').trim();
      const qty = Math.max(1, Number(qtyInput.value)||0);
      const mt = Number(meeshoTotal.value) || 0;
      if(!name){ alert('Enter product name'); return; }
      if(qty <= 0 || mt <= 0){ alert('Enter valid quantity & Meesho total'); return; }
      // stage the meesho order
      stagedMeesho = {
        productName: name,
        productSlug: slugify(name),
        quantity: qty,
        meeshoTotal: mt,
        meeshoUnit: +(mt/qty)
      };
      // show modal
      modalProductInfo.textContent = `${stagedMeesho.productName} — Q: ${stagedMeesho.quantity} — Meesho/unit: ${fmt(stagedMeesho.meeshoUnit)}`;
      localTotalInput.value = '';
      modalRoot.classList.remove('hidden');
      modalRoot.querySelector('.modal-backdrop').style.display = 'flex';
      setTimeout(()=> localTotalInput.focus(), 150);
    });

    modalCancel.addEventListener('click', ()=> {
      stagedMeesho = null;
      modalRoot.classList.add('hidden');
      modalRoot.querySelector('.modal-backdrop').style.display = 'none';
    });

    modalSave.addEventListener('click', async ()=>{
      if(!stagedMeesho){ alert('No staged order'); return; }
      const localTotal = Number(localTotalInput.value) || 0;
      if(localTotal <= 0){ alert('Enter local total amount'); return; }

      // compute units & profit
      const q = stagedMeesho.quantity;
      const localUnit = localTotal / q;
      const profit = (stagedMeesho.meeshoUnit - localUnit) * q; // positive if Meesho gives higher unit price than Local baseline

      // build order record
      const order = {
        productName: stagedMeesho.productName,
        productSlug: stagedMeesho.productSlug,
        quantity: q,
        meeshoTotal: stagedMeesho.meeshoTotal,
        meeshoUnit: +stagedMeesho.meeshoUnit,
        localTotal: localTotal,
        localUnit: +localUnit,
        profit: +profit,
        timestamp: now()
      };

      try{
        // save order
        const newOrderRef = push(ref(db, 'orders'));
        await set(newOrderRef, order);

        // update product aggregates
        const prodRef = ref(db, `products/${order.productSlug}`);
        await runTransaction(prodRef, current=>{
          if(current === null){
            const obj = { name: order.productName, slug: order.productSlug, lastUpdated: now() };
            obj.meesho = { totalQuantity: order.quantity, totalRevenue: order.meeshoTotal, avgUnitPrice: order.meeshoUnit };
            obj.local = { totalQuantity: order.quantity, totalRevenue: order.localTotal, avgUnitPrice: order.localUnit };
            return obj;
          } else {
            current.name = current.name || order.productName;
            current.lastUpdated = now();
            const m = current.meesho || { totalQuantity:0, totalRevenue:0, avgUnitPrice:0 };
            m.totalQuantity = (m.totalQuantity||0) + order.quantity;
            m.totalRevenue = (m.totalRevenue||0) + order.meeshoTotal;
            m.avgUnitPrice = m.totalQuantity ? (m.totalRevenue / m.totalQuantity) : 0;
            current.meesho = m;

            const l = current.local || { totalQuantity:0, totalRevenue:0, avgUnitPrice:0 };
            l.totalQuantity = (l.totalQuantity||0) + order.quantity;
            l.totalRevenue = (l.totalRevenue||0) + order.localTotal;
            l.avgUnitPrice = l.totalQuantity ? (l.totalRevenue / l.totalQuantity) : 0;
            current.local = l;

            return current;
          }
        });

        alert('Order saved with local price.');
        // cleanup/states
        stagedMeesho = null;
        modalRoot.classList.add('hidden');
        modalRoot.querySelector('.modal-backdrop').style.display = 'none';
        btnClearForm.click();

      } catch(e){
        console.error(e);
        alert('Failed to save order: ' + (e.message || e));
      }
    });

    // ---------- product history view ----------
    async function showProductHistory(slug){
      // collect orders for slug
      const arr = Object.entries(ordersCache || {}).map(([id,o])=>({id,...o})).filter(o=>o.productSlug === slug).sort((a,b)=>b.timestamp - a.timestamp);
      if(arr.length === 0){ alert('No history'); return; }
      let txt = `History: ${productsCache[slug]?.name || slug}\n\n`;
      arr.forEach(r => { txt += `${new Date(r.timestamp).toLocaleString()} | ${r.platform || 'meesho'} | Q:${r.quantity} | Meesho: ${fmt(r.meeshoUnit)} | Local: ${fmt(r.localUnit)} | Profit: ${fmt(r.profit)}\n`; });
      alert(txt);
    }

    // ---------- reports & compute ----------
    function populateProductFilter(){
      reportProduct.innerHTML = '<option value="">-- All products --</option>';
      Object.values(productsCache).forEach(p=>{
        const opt = document.createElement('option'); opt.value = p.slug; opt.textContent = p.name || p.slug;
        reportProduct.appendChild(opt);
      });
    }

    btnApplyFilter.addEventListener('click', ()=> applyFiltersAndShow());
    btnResetFilter.addEventListener('click', ()=>{
      fromDate.value = ''; toDate.value = ''; reportProduct.value = ''; reportPlatform.value = ''; applyFiltersAndShow();
    });

    btnRefresh.addEventListener('click', ()=>{
      renderRecentOrders(); renderProductsPanel(); computeSummary(); alert('Refreshed');
    });

    function applyFiltersAndShow(){
      const pSlug = reportProduct.value || '';
      const platform = reportPlatform.value || '';
      const fromTS = fromDate.value ? new Date(fromDate.value + 'T00:00:00').getTime() : 0;
      const toTS = toDate.value ? new Date(toDate.value + 'T23:59:59').getTime() : Date.now();

      const arr = Object.entries(ordersCache || {}).map(([id,o])=>({id,...o})).filter(o=>{
        if(o.timestamp < fromTS || o.timestamp > toTS) return false;
        if(pSlug && o.productSlug !== pSlug) return false;
        if(platform && !(platform === 'meesho' ? (o.meeshoTotal>0) : (o.localTotal>0))) return false;
        return true;
      }).sort((a,b)=>b.timestamp - a.timestamp);

      // summary computation for filtered set
      const totOrders = arr.length;
      const totItems = arr.reduce((s,o)=> s + (o.quantity||0), 0);
      const meeshoRev = arr.reduce((s,o)=> s + (o.meeshoTotal||0), 0);
      const localRev = arr.reduce((s,o)=> s + (o.localTotal||0), 0);
      const totalProfit = arr.reduce((s,o)=> s + (o.profit||0), 0);

      alert(`Filtered: Orders ${totOrders} | Items ${totItems}\nMeesho ${fmt(meeshoRev)} | Local ${fmt(localRev)}\nTotal Profit ${fmt(totalProfit)}\n\n(See chart below for distribution)`);

      updateRevenueChart(arr);
    }

    // compute global summary
    function computeSummary(){
      const arr = Object.values(ordersCache || {});
      const totalOrders = arr.length;
      const totalItems = arr.reduce((s,o)=> s + (o.quantity||0), 0);
      const meeshoRev = arr.reduce((s,o)=> s + (o.meeshoTotal||0), 0);
      const localRev = arr.reduce((s,o)=> s + (o.localTotal||0), 0);
      const totalProfit = arr.reduce((s,o)=> s + (o.profit||0), 0);

      totalOrdersEl.textContent = totalOrders;
      totalItemsEl.textContent = totalItems;
      meeshoRevEl.textContent = fmt(meeshoRev);
      localRevEl.textContent = fmt(localRev);
      totalProfitEl.textContent = fmt(totalProfit);
    }

    // ---------- chart ----------
    function updateRevenueChart(filteredArr){
      const arr = filteredArr ? filteredArr.slice() : Object.values(ordersCache || {});
      // group revenue by product
      const productBuckets = {};
      arr.forEach(o=>{
        const name = o.productName || o.productSlug;
        productBuckets[name] = (productBuckets[name]||0) + (o.meeshoTotal || 0) + (o.localTotal || 0);
      });
      const labels = Object.keys(productBuckets).slice(0, 12);
      const data = labels.map(l => productBuckets[l]);

      // profit vs loss pie
      const profitSum = arr.reduce((s,o)=> s + Math.max(0,o.profit||0), 0);
      const lossSum = arr.reduce((s,o)=> s + Math.max(0, -(o.profit||0)), 0);

      if(revenueChart) revenueChart.destroy();
      revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Revenue (Meesho+Local)', data, backgroundColor: labels.map(()=> 'rgba(99,102,241,0.8)') }]
        },
        options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // ---------- export CSV (all orders) ----------
    btnExport.addEventListener('click', async ()=>{
      const arr = Object.values(ordersCache || {}).map(o=>o).sort((a,b)=> b.timestamp - a.timestamp);
      if(arr.length === 0){ alert('No orders to export'); return; }
      let csv = 'Date,Product,Quantity,MeeshoTotal,MeeshoUnit,LocalTotal,LocalUnit,Profit\\n';
      arr.forEach(o=>{
        csv += `"${new Date(o.timestamp).toLocaleString()}","${o.productName}",${o.quantity},${o.meeshoTotal},${o.meeshoUnit},${o.localTotal},${o.localUnit},${o.profit}\\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'orders_export.csv'; a.click();
      URL.revokeObjectURL(a.href);
    });

    // ---------- helpers: local cache restore & start ----------
    (function loadLocalCache(){
      try{
        const pc = JSON.parse(localStorage.getItem('products_cache')||'{}');
        const oc = JSON.parse(localStorage.getItem('orders_cache')||'{}');
        if(Object.keys(pc).length) productsCache = pc;
        if(Object.keys(oc).length) ordersCache = oc;
      }catch(e){}
    })();

    // persist local caches periodically
    setInterval(()=> {
      try{ localStorage.setItem('products_cache', JSON.stringify(productsCache)); localStorage.setItem('orders_cache', JSON.stringify(ordersCache)); }catch(e){}
    }, 5000);

    // load realtime when user signs in (handled in attachRealtime)
    // END of module
  </script>
</body>
</html>
